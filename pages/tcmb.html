<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MFA TCMB Widget</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg:#0b1221;
      --bg2:#0f172a;
      --panel:#101a30;
      --accent:#22d3ee;
      --accent-soft:rgba(34,211,238,0.18);
      --accent2:#a855f7;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --border-soft:rgba(148,163,184,0.25);
      --red:#f97373;
      --green:#22c55e;
    }
    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:"Inter","Segoe UI",sans-serif;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(circle at 15% 0%,rgba(34,211,238,0.14),transparent 55%),
        radial-gradient(circle at 80% 100%,rgba(168,85,247,0.18),transparent 55%),
        linear-gradient(135deg,#020617 0%,#020617 40%,#0b1221 100%);
      position:relative;
      overflow-x:hidden;
    }

    /* Ambient orbs */
    .orb{
      position:fixed;
      width:280px;
      height:280px;
      border-radius:999px;
      filter:blur(40px);
      opacity:0.45;
      pointer-events:none;
      mix-blend-mode:screen;
      z-index:0;
    }
    .orb-1{
      top:-80px;left:-60px;
      background:radial-gradient(circle,#22d3ee,#0f172a);
      animation:orbFloat1 22s ease-in-out infinite alternate;
    }
    .orb-2{
      bottom:-120px;right:-80px;
      background:radial-gradient(circle,#a855f7,#020617);
      animation:orbFloat2 26s ease-in-out infinite alternate;
    }
    @keyframes orbFloat1{
      0%{transform:translate3d(0,0,0);}
      50%{transform:translate3d(40px,30px,0);}
      100%{transform:translate3d(10px,80px,0);}
    }
    @keyframes orbFloat2{
      0%{transform:translate3d(0,0,0);}
      50%{transform:translate3d(-40px,-30px,0);}
      100%{transform:translate3d(-10px,-90px,0);}
    }

    header{
      max-width:1080px;
      margin:0 auto;
      padding:28px 16px 8px;
      position:relative;
      z-index:1;
    }
    h1{margin:0;font-size:30px;letter-spacing:0.3px;}
    p.lead{margin:6px 0 0;color:var(--muted);}

    .home-link{
      padding:8px 12px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.6);
      background:linear-gradient(135deg,rgba(15,23,42,0.9),rgba(15,23,42,0.4));
      text-decoration:none;
      color:var(--text);
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      position:relative;
      overflow:hidden;
      transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .home-link::before{
      content:"";
      position:absolute;
      inset:-80%;
      background:conic-gradient(from 0deg,transparent 40%,rgba(34,211,238,0.45),transparent 60%);
      opacity:0;
      animation:spinBorder 10s linear infinite;
    }
    .home-link::after{
      content:"";
      position:absolute;
      inset:1px;
      border-radius:inherit;
      background:radial-gradient(circle at 0 0,rgba(34,211,238,0.18),transparent 45%),
                  radial-gradient(circle at 100% 100%,rgba(168,85,247,0.14),transparent 40%),
                  rgba(15,23,42,0.96);
      z-index:-1;
    }
    .home-link span{
      position:relative;
      z-index:1;
    }
    .home-link:hover{
      transform:translateY(-1px);
      box-shadow:0 18px 45px rgba(15,23,42,0.9);
      border-color:rgba(34,211,238,0.8);
    }
    .home-link:hover::before{opacity:1;}
    @keyframes spinBorder{
      to{transform:rotate(360deg);}
    }

    .panel{
      max-width:1080px;
      margin:0 auto 40px;
      padding:18px;
      background:radial-gradient(circle at 0 0,rgba(34,211,238,0.16),transparent 55%),
                 radial-gradient(circle at 100% 100%,rgba(168,85,247,0.16),transparent 55%),
                 linear-gradient(145deg,#050816,#020617);
      border-radius:20px;
      border:1px solid rgba(148,163,184,0.4);
      box-shadow:
        0 24px 80px rgba(15,23,42,0.95),
        0 0 0 1px rgba(15,23,42,0.8) inset;
      position:relative;
      overflow:hidden;
      z-index:1;
    }
    .panel::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at 20% 0,rgba(34,211,238,0.25),transparent 55%);
      opacity:0;
      pointer-events:none;
      transition:opacity .4s ease;
    }
    .panel:hover::before{opacity:1;}

    .panel-inner{
      position:relative;
      z-index:1;
    }

    .bar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:14px;
      align-items:center;
    }

    .input-shell{
      position:relative;
      display:inline-flex;
      align-items:center;
    }
    .input-shell::before{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,0.8);
      background:linear-gradient(145deg,rgba(15,23,42,0.8),rgba(15,23,42,0.4));
      z-index:-1;
    }

    .bar input[type="date"],
    .bar input[type="number"]{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.4);
      background:radial-gradient(circle at 0 0,rgba(34,211,238,0.18),transparent 45%),
                 rgba(15,23,42,0.95);
      color:#e5e7eb;
      min-width:160px;
      font-size:13px;
      outline:none;
      box-shadow:0 12px 35px rgba(15,23,42,0.9);
      transition:border-color .15s ease, box-shadow .15s ease, transform .15s ease;
    }
    .bar input[type="number"]{min-width:130px;}
    .bar input:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(34,211,238,0.6),0 18px 40px rgba(15,23,42,1);
      transform:translateY(-1px);
    }

    .btn{
      border:none;
      padding:10px 14px;
      border-radius:999px;
      background:radial-gradient(circle at 0 0,rgba(34,211,238,0.3),transparent 55%),
                 rgba(15,23,42,0.95);
      color:#e5e7eb;
      cursor:pointer;
      font-size:13px;
      letter-spacing:0.06em;
      text-transform:uppercase;
      border:1px solid rgba(148,163,184,0.5);
      display:inline-flex;
      align-items:center;
      gap:6px;
      position:relative;
      overflow:hidden;
      transition:transform .16s ease, box-shadow .16s ease, border-color .16s ease, background .16s ease, color .16s ease;
    }
    .btn::before{
      content:"";
      position:absolute;
      inset:-120%;
      background:linear-gradient(120deg,transparent 0%,rgba(255,255,255,0.19) 50%,transparent 100%);
      opacity:0;
      transform:translateX(-40%);
      transition:opacity .3s ease, transform .3s ease;
    }
    .btn span{
      position:relative;
      z-index:1;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 18px 38px rgba(15,23,42,1);
      border-color:rgba(34,211,238,0.9);
      background:radial-gradient(circle at 100% 0,rgba(168,85,247,0.35),transparent 55%),
                 rgba(15,23,42,0.98);
    }
    .btn:hover::before{
      opacity:1;
      transform:translateX(40%);
    }

    .btn-primary{
      background:linear-gradient(135deg,#22d3ee,#0ea5e9);
      color:#020617;
      border-color:rgba(34,211,238,0.9);
      box-shadow:0 16px 38px rgba(34,211,238,0.35);
    }
    .btn-primary:hover{
      background:linear-gradient(135deg,#38bdf8,#0ea5e9);
      box-shadow:0 20px 50px rgba(34,211,238,0.5);
      color:#020617;
    }

    .btn-compare{
      font-size:11px;
      padding:7px 11px;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(148,163,184,0.5);
      color:var(--muted);
      text-transform:none;
      letter-spacing:0.04em;
    }
    .btn-compare.active{
      background:radial-gradient(circle at 0 0,rgba(248,113,113,0.4),transparent 60%),
                 rgba(15,23,42,0.98);
      border-color:rgba(248,113,113,0.9);
      color:#fee2e2;
      box-shadow:0 12px 35px rgba(15,23,42,0.95);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      color:#7dd3fc;
      font-size:11px;
      border:1px solid rgba(56,189,248,0.5);
      box-shadow:0 12px 32px rgba(15,23,42,0.9);
    }
    .badge-muted{
      background:rgba(15,23,42,0.92);
      color:var(--muted);
      border-color:rgba(148,163,184,0.45);
    }

    .status-dot{
      width:6px;height:6px;border-radius:999px;background:#22c55e;
      box-shadow:0 0 0 4px rgba(34,197,94,0.28);
    }
    .status-loading{background:#facc15;box-shadow:0 0 0 4px rgba(250,204,21,0.3);}
    .status-error{background:#f97373;box-shadow:0 0 0 4px rgba(248,113,113,0.3);}

    .cards{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:14px;
      margin-top:8px;
    }

    .card{
      background:radial-gradient(circle at 0 0,rgba(34,211,238,0.12),transparent 55%),
                 rgba(15,23,42,0.97);
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.5);
      padding:12px 12px 11px;
      position:relative;
      overflow:hidden;
      cursor:pointer;
      transform-origin:center top;
      transform:translateY(0) translateZ(0);
      box-shadow:0 14px 40px rgba(15,23,42,0.95);
      transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
      opacity:0;
      animation:cardIn .28s ease forwards;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at 0 0,rgba(34,211,238,0.27),transparent 60%);
      opacity:0;
      pointer-events:none;
      transition:opacity .22s ease;
    }
    .card:hover{
      transform:translateY(-4px) scale(1.01);
      box-shadow:0 20px 52px rgba(15,23,42,1);
      border-color:rgba(34,211,238,0.85);
      background:radial-gradient(circle at 100% 0,rgba(168,85,247,0.22),transparent 60%),
                 rgba(15,23,42,0.99);
    }
    .card:hover::before{opacity:1;}
    .card.active-card{
      border-color:rgba(34,211,238,0.95);
      box-shadow:0 22px 60px rgba(34,211,238,0.35);
    }

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      margin-bottom:6px;
    }
    .card-title{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .pair{
      font-weight:600;
      font-size:14px;
      letter-spacing:0.05em;
    }
    .name{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.08em;
    }
    .card-chip{
      font-size:10px;
      padding:3px 7px;
      border-radius:999px;
      background:rgba(15,23,42,0.88);
      border:1px solid rgba(148,163,184,0.6);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .card-chip-dot{
      width:7px;height:7px;border-radius:999px;
      background:radial-gradient(circle,#22d3ee,#0ea5e9);
      box-shadow:0 0 10px rgba(34,211,238,0.8);
    }

    .rates{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      margin-bottom:4px;
    }
    .rates span.label{color:var(--muted);font-size:11px;display:block;}

    .conversion{
      font-size:11px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-top:4px;
    }
    .conversion-amount{
      font-family:"JetBrains Mono","SF Mono",ui-monospace,monospace;
      font-size:11px;
      color:#e5e7eb;
    }

    .change{
      margin-top:5px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:5px;
      padding:3px 7px;
      border-radius:999px;
      background:rgba(15,23,42,0.96);
      border:1px solid rgba(148,163,184,0.5);
      box-shadow:0 10px 24px rgba(15,23,42,0.9);
    }
    .change-label{
      text-transform:uppercase;
      letter-spacing:0.07em;
      color:var(--muted);
      font-size:10px;
    }
    .change-up{
      color:var(--red);
      border-color:rgba(248,113,113,0.65);
      background:rgba(30,7,8,0.9);
    }
    .change-down{
      color:var(--green);
      border-color:rgba(34,197,94,0.6);
      background:rgba(5,30,15,0.9);
    }
    .change-flat{
      color:var(--muted);
    }
    .arrow{
      font-size:12px;
    }

    #resultDate{
      margin-bottom:10px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    @keyframes cardIn{
      from{opacity:0;transform:translateY(6px) scale(0.98);}
      to{opacity:1;transform:translateY(0) scale(1);}
    }

    /* ANALYTICS (Chart.js panel) */
    .analytics{
      margin-top:24px;
      padding:14px 10px 8px;
      border-radius:16px;
      background:
        radial-gradient(circle at 0 0,rgba(34,211,238,0.12),transparent 55%),
        radial-gradient(circle at 100% 100%,rgba(168,85,247,0.18),transparent 55%),
        rgba(15,23,42,0.96);
      border:1px solid rgba(51,65,85,0.9);
      box-shadow:0 20px 55px rgba(15,23,42,0.95);
    }
    .analytics-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:14px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .analytics-title{
      font-size:16px;
      font-weight:600;
      letter-spacing:0.08em;
      text-transform:uppercase;
    }
    .analytics-sub{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    .analytics-meta{
      text-align:right;
      font-size:11px;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      gap:3px;
      align-items:flex-end;
    }
    .analytics-meta span:first-child{
      font-size:13px;
      font-weight:600;
      color:#e5e7eb;
    }

    .analytics-kpis{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:10px;
      margin-bottom:14px;
    }
    .kpi-card{
      border-radius:12px;
      padding:9px 10px;
      background:linear-gradient(145deg,rgba(15,23,42,0.9),rgba(15,23,42,0.75));
      border:1px solid rgba(51,65,85,0.9);
      box-shadow:0 14px 38px rgba(15,23,42,0.9);
    }
    .kpi-label{
      font-size:11px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .kpi-value{
      font-size:18px;
      font-weight:600;
    }
    .kpi-sub{
      font-size:11px;
      color:var(--muted);
      margin-top:2px;
    }
    .kpi-up{color:var(--green);}
    .kpi-down{color:var(--red);}

    .analytics-main{
      display:grid;
      grid-template-columns:minmax(0,2.2fr) minmax(0,1.4fr);
      gap:14px;
    }
    .analytics-block{
      border-radius:12px;
      background:rgba(15,23,42,0.96);
      border:1px solid rgba(51,65,85,0.9);
      box-shadow:0 16px 40px rgba(15,23,42,0.95);
      padding:10px 10px 8px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:0;
    }
    .analytics-block-header{
      font-size:13px;
      font-weight:500;
      display:flex;
      justify-content:space-between;
      align-items:center;
      color:#e5e7eb;
    }
    .analytics-block-sub{
      font-size:11px;
      color:var(--muted);
    }
    .analytics-chart-wrap{
      position:relative;
      width:100%;
      min-height:200px;
      height:220px;
    }
    #mainChart,#spreadChart{
      width:100%;
      height:100%;
      display:block;
    }

    .analytics-yearly{
      margin-top:6px;
      border-radius:10px;
      background:rgba(15,23,42,0.96);
      border:1px solid rgba(30,64,175,0.4);
      max-height:210px;
      overflow:auto;
    }
    .analytics-yearly table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    .analytics-yearly thead{
      background:rgba(15,23,42,0.98);
      position:sticky;
      top:0;
      z-index:1;
    }
    .analytics-yearly th,
    .analytics-yearly td{
      padding:6px 8px;
      border-bottom:1px solid rgba(30,64,175,0.3);
    }
    .analytics-yearly th{
      text-align:left;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.06em;
      font-size:10px;
      color:#e5e7eb;
    }
    .analytics-yearly tbody tr:nth-child(odd){
      background:rgba(15,23,42,0.95);
    }
    .analytics-yearly tbody tr:nth-child(even){
      background:rgba(15,23,42,0.9);
    }
    .analytics-yearly tbody tr:hover{
      background:rgba(30,64,175,0.35);
    }

    /* Zaman filtresi barı */
    .analytics-ranges{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .range-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .range-btn{
      border-radius:999px;
      border:1px solid rgba(51,65,85,0.9);
      background:rgba(15,23,42,0.95);
      color:var(--muted);
      font-size:10px;
      padding:5px 9px;
      cursor:pointer;
      letter-spacing:0.06em;
      text-transform:uppercase;
      transition:background .15s ease,border-color .15s ease,color .15s ease,transform .15s ease,box-shadow .15s ease;
    }
    .range-btn.active{
      background:radial-gradient(circle at 0 0,rgba(34,211,238,0.5),transparent 60%),rgba(15,23,42,0.98);
      border-color:rgba(34,211,238,0.9);
      color:#e5e7eb;
      transform:translateY(-1px);
      box-shadow:0 10px 26px rgba(15,23,42,0.9);
    }
    .range-custom{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      align-items:center;
      font-size:10px;
      color:var(--muted);
    }
    .range-custom label{
      font-size:10px;
    }
    .range-custom input[type="date"]{
      background:rgba(15,23,42,0.95);
      border-radius:999px;
      border:1px solid rgba(51,65,85,0.9);
      color:#e5e7eb;
      font-size:10px;
      padding:4px 7px;
      outline:none;
    }
    .range-custom input[type="date"]:focus{
      border-color:rgba(34,211,238,0.9);
    }
    .btn-compact{
      padding:5px 10px;
      font-size:10px;
    }

    /* Scroll top button */
    .scroll-top-btn{
      position:fixed;
      bottom:18px;
      right:18px;
      width:40px;
      height:40px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:radial-gradient(circle at 0 0,rgba(34,211,238,0.45),transparent 55%),
                 rgba(15,23,42,0.98);
      color:#e5e7eb;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 14px 40px rgba(15,23,42,0.95);
      z-index:30;
      transition:opacity .2s ease, transform .2s ease;
    }
    .scroll-top-btn.hide{
      opacity:0;
      pointer-events:none;
      transform:translateY(8px);
    }

    @media (max-width:900px){
      .analytics-main{
        grid-template-columns:1fr;
      }
      .analytics-chart-wrap{
        height:240px;
      }
    }

    @media (max-width:720px){
      .bar{align-items:flex-start;}
      .analytics-ranges{
        flex-direction:column;
        align-items:flex-start;
      }
      .range-custom{width:100%;}
    }

    @media (max-width:600px){
      .analytics{
        padding:10px 8px 6px;
      }
      .analytics-chart-wrap{
        min-height:230px;
        height:260px;
      }
    }

    @media (prefers-reduced-motion: reduce){
      *, *::before, *::after{
        animation:none !important;
        transition:none !important;
        scroll-behavior:auto !important;
      }
    }
  </style>
</head>
<body>
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>

  <header id="pageHeader" style="display:flex;align-items:flex-start;gap:12px;flex-wrap:wrap;position:relative;z-index:2;">
    <a class="home-link" href="../index.html" id="homeLink">
      <span>◀</span><span id="homeText">Ana sayfa</span>
    </a>
    <div>
      <h1 id="headerTitle">TCMB Kurları</h1>
      <p class="lead" id="headerLead">Güncel ve tarih bazlı kur verileri, TL miktarı ile birlikte; 1G / 7G / 1A değişim karşılaştırmaları.</p>
    </div>
  </header>

  <div class="panel">
    <div class="panel-inner">
      <div class="bar">
        <div class="input-shell">
          <input type="date" id="dateInput">
        </div>
        <div class="input-shell">
          <input type="number" id="amountInput" value="1" min="1" step="1" placeholder="TL miktarı">
        </div>
        <button class="btn btn-primary" id="btnLatest"><span>Güncel</span></button>
        <button class="btn" id="btnFetch"><span>Ara</span></button>

        <div style="flex:1 1 auto"></div>

        <button class="btn btn-compare" data-days="1" id="btn1g"><span>1 Gün</span></button>
        <button class="btn btn-compare" data-days="7" id="btn7g"><span>7 Gün</span></button>
        <button class="btn btn-compare" data-days="30" id="btn30g"><span>1 Ay</span></button>

        <button class="btn" id="btnScrollAnalytics"><span>Detay Analiz</span></button>

        <span class="badge badge-muted" id="status">
          <span class="status-dot"></span>
          <span>Hazır</span>
        </span>
      </div>

      <div id="resultDate" class="badge badge-muted"></div>

      <div class="cards" id="cards"></div>

      <!-- ANALYTICS -->
      <div class="analytics" id="analyticsSection">
        <div class="analytics-header">
          <div>
            <div class="analytics-title" id="analyticsTitle">Detaylı Kur Analizi</div>
            <div class="analytics-sub" id="analyticsSubtitle">ABD DOLARI · USD</div>
          </div>
          <div class="analytics-meta">
            <span id="analyticsPair">USD/TRY</span>
            <span id="analyticsRange">Veri aralığı: -- / --</span>
            <span id="analyticsStart"></span>
          </div>
        </div>

        <div class="analytics-ranges">
          <div class="range-buttons">
            <button class="range-btn active" data-range="all" id="rangeAll">Tümü</button>
            <button class="range-btn" data-range="7d" id="range7d">1 Hafta</button>
            <button class="range-btn" data-range="30d" id="range30d">1 Ay</button>
            <button class="range-btn" data-range="1y" id="range1y">1 Yıl</button>
            <button class="range-btn" data-range="2y" id="range2y">2 Yıl</button>
            <button class="range-btn" data-range="5y" id="range5y">5 Yıl</button>
          </div>
          <div class="range-custom">
            <label for="chartFrom" id="labelChartFrom">Başlangıç</label>
            <input type="date" id="chartFrom">
            <label for="chartTo" id="labelChartTo">Bitiş</label>
            <input type="date" id="chartTo">
            <button class="btn btn-compact" id="rangeApply"><span>Uygula</span></button>
          </div>
        </div>

        <div class="analytics-kpis">
          <div class="kpi-card">
            <div class="kpi-label" id="kpiLabelCurrent">Son Satış Kuru</div>
            <div class="kpi-value" id="kpiCurrent">--</div>
            <div class="kpi-sub" id="kpiCurrentSub"></div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label" id="kpiLabelChange">Toplam Değişim</div>
            <div class="kpi-value" id="kpiChange">--</div>
            <div class="kpi-sub" id="kpiChangeSub"></div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label" id="kpiLabelHigh">En Yüksek Değer (ATH)</div>
            <div class="kpi-value" id="kpiHigh">--</div>
            <div class="kpi-sub" id="kpiHighDate">Tarih: --</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label" id="kpiLabelSpread">Ort. Alış/Satış Makası</div>
            <div class="kpi-value" id="kpiSpread">--</div>
            <div class="kpi-sub" id="kpiSpreadSub"></div>
          </div>
        </div>

        <div class="analytics-main">
          <div class="analytics-block">
            <div class="analytics-block-header">
              <span id="mainChartTitle">Zaman İçinde Değişim (Alış / Satış)</span>
            </div>
            <div class="analytics-block-sub" id="mainChartSub"></div>
            <div class="analytics-chart-wrap">
              <canvas id="mainChart"></canvas>
            </div>
          </div>

          <div class="analytics-block">
            <div class="analytics-block-header">
              <span id="spreadChartTitle">Makas (Spread) Analizi</span>
            </div>
            <div class="analytics-block-sub" id="spreadChartSub"></div>
            <div class="analytics-chart-wrap" style="height:140px;margin-bottom:6px;">
              <canvas id="spreadChart"></canvas>
            </div>
            <div class="analytics-block-header" style="margin-top:2px;">
              <span id="yearlyTitle">Yıllık Ortalama Değerler</span>
            </div>
            <div class="analytics-yearly">
              <table>
                <thead>
                  <tr>
                    <th id="thYear">Yıl</th>
                    <th id="thAvgBuy">Ort. Alış</th>
                    <th id="thAvgSell">Ort. Satış</th>
                    <th id="thYearChange">Yıllık Değişim (%)</th>
                  </tr>
                </thead>
                <tbody id="statsTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <!-- /ANALYTICS -->
    </div>
  </div>

  <!-- Yukarı dön butonu -->
  <button class="scroll-top-btn hide" id="btnScrollTop">▲</button>

  <script>
  (function(){
    // Dil tercihi
    const pref = (typeof localStorage !== "undefined" && localStorage.getItem("prefLang")) || "en";
    const prefLang = pref === "tr" ? "tr" : "en";
    document.documentElement.lang = prefLang;

    const texts = {
      tr: {
        pageTitle: "MFA TCMB Widget",
        home: "Ana sayfa",
        headerTitle: "TCMB Kurları",
        headerLead: "Güncel ve tarih bazlı kur verileri, TL miktarı ile birlikte; 1G / 7G / 1A değişim karşılaştırmaları.",
        latestBtn: "Güncel",
        fetchBtn: "Ara",
        amountPlaceholder: "TL miktarı",
        cmp1: "1 Gün",
        cmp7: "7 Gün",
        cmp30: "1 Ay",
        chipChart: "Detaylı Analiz",
        statusReady: "Hazır",
        statusLoading: "Yükleniyor...",
        statusError: "Hata",
        noData: "Veri yok",
        fetchError: "Veri alınamadı.",
        dateLabelPrefix: "",
        convLabel: (amountStr) => `${amountStr} TL karşılığı`,
        labelBid: "Alış",
        labelAsk: "Satış",
        changeWord: "DEĞİŞİM",

        analyticsTitle: "Detaylı Kur Analizi",
        analyticsRangeLabel: (from,to)=>`Veri aralığı: ${from} / ${to}`,
        analyticsStartLabel: (start)=>`Veri başlangıcı: ${start}`,
        mainChartTitle: "Zaman İçinde Değişim (Alış / Satış)",
        mainChartSub: "TCMB verilerine göre seçili para biriminin zaman içindeki satış ve alış kurları.",
        spreadChartTitle: "Makas (Spread) Analizi",
        spreadChartSub: "Bankanın alış ve satış fiyatı arasındaki farkın zaman içindeki değişimi.",
        yearlyTitle: "Yıllık Ortalama Değerler",
        kpiCurrentLabel: "Son Satış Kuru",
        kpiCurrentSub: "Veri setindeki son güncel satış kuru.",
        kpiTotalChangeLabel: "Toplam Değişim",
        kpiTotalChangeSub: "Veri başlangıcından bugüne yüzde değişim.",
        kpiHighLabel: "En Yüksek Değer (ATH)",
        kpiHighDatePrefix: "Tarih:",
        kpiSpreadLabel: "Ort. Alış/Satış Makası",
        kpiSpreadSub: "Dönem boyunca ortalama alış-satış farkı.",
        yearlyThYear: "Yıl",
        yearlyThAvgBuy: "Ort. Alış",
        yearlyThAvgSell: "Ort. Satış",
        yearlyThChange: "Yıllık Değişim (%)",
        scrollAnalyticsBtn: "Detay Analiz",
        rangeAll: "Tümü",
        range7d: "1 Hafta",
        range30d: "1 Ay",
        range1y: "1 Yıl",
        range2y: "2 Yıl",
        range5y: "5 Yıl",
        rangeFrom: "Başlangıç",
        rangeTo: "Bitiş",
        rangeApply: "Uygula"
      },
      en: {
        pageTitle: "MFA CBRT FX Widget",
        home: "Home",
        headerTitle: "CBRT Exchange Rates",
        headerLead: "Latest and historical FX rates with TRY amount; 1D / 7D / 1M change comparisons.",
        latestBtn: "Latest",
        fetchBtn: "Search",
        amountPlaceholder: "Amount in TRY",
        cmp1: "1 Day",
        cmp7: "7 Days",
        cmp30: "1 Month",
        chipChart: "Detailed Analytics",
        statusReady: "Ready",
        statusLoading: "Loading...",
        statusError: "Error",
        noData: "No data",
        fetchError: "Data could not be retrieved.",
        dateLabelPrefix: "",
        convLabel: (amountStr) => `Value of ${amountStr} TRY`,
        labelBid: "Bid",
        labelAsk: "Ask",
        changeWord: "CHANGE",

        analyticsTitle: "Detailed FX Analytics",
        analyticsRangeLabel: (from,to)=>`Data range: ${from} / ${to}`,
        analyticsStartLabel: (start)=>`Data start: ${start}`,
        mainChartTitle: "Time Series (Bid / Ask)",
        mainChartSub: "CBRT time series for the selected currency's selling and buying rates.",
        spreadChartTitle: "Spread Analysis",
        spreadChartSub: "Change of bid/ask spread over time.",
        yearlyTitle: "Yearly Average Values",
        kpiCurrentLabel: "Last Selling Rate",
        kpiCurrentSub: "Most recent selling price in the dataset.",
        kpiTotalChangeLabel: "Total Change",
        kpiTotalChangeSub: "Percentage change from first to last point.",
        kpiHighLabel: "All-Time High (ATH)",
        kpiHighDatePrefix: "Date:",
        kpiSpreadLabel: "Avg. Bid/Ask Spread",
        kpiSpreadSub: "Average difference between buying and selling.",
        yearlyThYear: "Year",
        yearlyThAvgBuy: "Avg. Bid",
        yearlyThAvgSell: "Avg. Ask",
        yearlyThChange: "Year Change (%)",
        scrollAnalyticsBtn: "Details",
        rangeAll: "All",
        range7d: "1 Week",
        range30d: "1 Month",
        range1y: "1 Year",
        range2y: "2 Years",
        range5y: "5 Years",
        rangeFrom: "From",
        rangeTo: "To",
        rangeApply: "Apply"
      }
    };
    const t = texts[prefLang];

    document.title = t.pageTitle;

    // UI eleman referansları
    const homeText = document.getElementById("homeText");
    const headerTitle = document.getElementById("headerTitle");
    const headerLead = document.getElementById("headerLead");
    const dateInput = document.getElementById("dateInput");
    const amountInput = document.getElementById("amountInput");
    const cards = document.getElementById("cards");
    const status = document.getElementById("status");
    const resultDate = document.getElementById("resultDate");
    const btnLatest = document.getElementById("btnLatest");
    const btnFetch = document.getElementById("btnFetch");
    const btn1g = document.getElementById("btn1g");
    const btn7g = document.getElementById("btn7g");
    const btn30g = document.getElementById("btn30g");
    const btnScrollAnalytics = document.getElementById("btnScrollAnalytics");
    const btnScrollTop = document.getElementById("btnScrollTop");
    const headerEl = document.getElementById("pageHeader");
    const analyticsSection = document.getElementById("analyticsSection");

    // Analytics DOM
    const analyticsTitleEl = document.getElementById("analyticsTitle");
    const analyticsSubtitleEl = document.getElementById("analyticsSubtitle");
    const analyticsPairEl = document.getElementById("analyticsPair");
    const analyticsRangeEl = document.getElementById("analyticsRange");
    const analyticsStartEl = document.getElementById("analyticsStart");

    const kpiLabelCurrent = document.getElementById("kpiLabelCurrent");
    const kpiCurrent = document.getElementById("kpiCurrent");
    const kpiCurrentSub = document.getElementById("kpiCurrentSub");
    const kpiLabelChange = document.getElementById("kpiLabelChange");
    const kpiChange = document.getElementById("kpiChange");
    const kpiChangeSub = document.getElementById("kpiChangeSub");
    const kpiLabelHigh = document.getElementById("kpiLabelHigh");
    const kpiHigh = document.getElementById("kpiHigh");
    const kpiHighDate = document.getElementById("kpiHighDate");
    const kpiLabelSpread = document.getElementById("kpiLabelSpread");
    const kpiSpread = document.getElementById("kpiSpread");
    const kpiSpreadSub = document.getElementById("kpiSpreadSub");

    const mainChartTitleEl = document.getElementById("mainChartTitle");
    const mainChartSubEl = document.getElementById("mainChartSub");
    const spreadChartTitleEl = document.getElementById("spreadChartTitle");
    const spreadChartSubEl = document.getElementById("spreadChartSub");
    const yearlyTitleEl = document.getElementById("yearlyTitle");
    const thYear = document.getElementById("thYear");
    const thAvgBuy = document.getElementById("thAvgBuy");
    const thAvgSell = document.getElementById("thAvgSell");
    const thYearChange = document.getElementById("thYearChange");
    const statsTableBody = document.getElementById("statsTableBody");

    const mainChartCanvas = document.getElementById("mainChart");
    const spreadChartCanvas = document.getElementById("spreadChart");

    // Range controls
    const rangeButtons = document.querySelectorAll(".range-btn");
    const rangeAllBtn = document.getElementById("rangeAll");
    const range7dBtn = document.getElementById("range7d");
    const range30dBtn = document.getElementById("range30d");
    const range1yBtn = document.getElementById("range1y");
    const range2yBtn = document.getElementById("range2y");
    const range5yBtn = document.getElementById("range5y");
    const chartFromInput = document.getElementById("chartFrom");
    const chartToInput = document.getElementById("chartTo");
    const rangeApplyBtn = document.getElementById("rangeApply");
    const labelChartFrom = document.getElementById("labelChartFrom");
    const labelChartTo = document.getElementById("labelChartTo");

    // Statik metinler
    if(homeText) homeText.textContent = t.home;
    if(headerTitle) headerTitle.textContent = t.headerTitle;
    if(headerLead) headerLead.textContent = t.headerLead;
    if(btnLatest) btnLatest.querySelector("span").textContent = t.latestBtn;
    if(btnFetch) btnFetch.querySelector("span").textContent = t.fetchBtn;
    if(amountInput) amountInput.placeholder = t.amountPlaceholder;
    if(btn1g) btn1g.querySelector("span").textContent = t.cmp1;
    if(btn7g) btn7g.querySelector("span").textContent = t.cmp7;
    if(btn30g) btn30g.querySelector("span").textContent = t.cmp30;
    if(status) status.lastChild.textContent = " " + t.statusReady;
    if(btnScrollAnalytics) btnScrollAnalytics.querySelector("span").textContent = t.scrollAnalyticsBtn;

    analyticsTitleEl.textContent = t.analyticsTitle;
    mainChartTitleEl.textContent = t.mainChartTitle;
    mainChartSubEl.textContent = t.mainChartSub;
    spreadChartTitleEl.textContent = t.spreadChartTitle;
    spreadChartSubEl.textContent = t.spreadChartSub;
    yearlyTitleEl.textContent = t.yearlyTitle;
    kpiLabelCurrent.textContent = t.kpiCurrentLabel;
    kpiCurrentSub.textContent = t.kpiCurrentSub;
    kpiLabelChange.textContent = t.kpiTotalChangeLabel;
    kpiChangeSub.textContent = t.kpiTotalChangeSub;
    kpiLabelHigh.textContent = t.kpiHighLabel;
    kpiLabelSpread.textContent = t.kpiSpreadLabel;
    kpiSpreadSub.textContent = t.kpiSpreadSub;
    thYear.textContent = t.yearlyThYear;
    thAvgBuy.textContent = t.yearlyThAvgBuy;
    thAvgSell.textContent = t.yearlyThAvgSell;
    thYearChange.textContent = t.yearlyThChange;

    rangeAllBtn.textContent = t.rangeAll;
    range7dBtn.textContent = t.range7d;
    range30dBtn.textContent = t.range30d;
    range1yBtn.textContent = t.range1y;
    range2yBtn.textContent = t.range2y;
    range5yBtn.textContent = t.range5y;
    labelChartFrom.textContent = t.rangeFrom;
    labelChartTo.textContent = t.rangeTo;
    rangeApplyBtn.querySelector("span").textContent = t.rangeApply;

    // TCMB URL (obfuscated)
    const obf = "aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS9NZWhtZXRGYXJ1a0FrYnVsdXQvNWViNGY4MjhlMGJiMTczZWNjNTljZTE1OWVhYTE5ZDMvcmF3L3RjbWIuanNvbg==";
    const TCMB_URL = (typeof window !== "undefined" && window.__TCMB_JSON_URL__) || atob(obf);

    const CODES = ["USD","EUR","GBP","CHF","CAD","AUD","DKK","SEK","NOK","SAR","JPY","BGN","RON","RUB","CNY","PKR","QAR"];
    const NAMES_TR = {
      USD:'ABD DOLARI', EUR:'EURO', GBP:'İNGİLİZ STERLİNİ', CHF:'İSVİÇRE FRANGI',
      CAD:'KANADA DOLARI', AUD:'AVUSTRALYA DOLARI', DKK:'DANİMARKA KRONU', SEK:'İSVEÇ KRONU',
      NOK:'NORVEÇ KRONU', SAR:'SUUDİ RİYALİ', JPY:'JAPON YENİ', BGN:'BULGAR LEVASI',
      RON:'RUMEN LEYİ', RUB:'RUS RUBLESİ', CNY:'ÇİN YUANI', PKR:'PAKİSTAN RUPİSİ',
      QAR:'KATAR RİYALİ'
    };
    const NAMES_EN = {
      USD:'US DOLLAR', EUR:'EURO', GBP:'BRITISH POUND', CHF:'SWISS FRANC',
      CAD:'CANADIAN DOLLAR', AUD:'AUSTRALIAN DOLLAR', DKK:'DANISH KRONE', SEK:'SWEDISH KRONA',
      NOK:'NORWEGIAN KRONE', SAR:'SAUDI RIYAL', JPY:'JAPANESE YEN', BGN:'BULGARIAN LEV',
      RON:'ROMANIAN LEU', RUB:'RUSSIAN RUBLE', CNY:'CHINESE YUAN', PKR:'PAKISTANI RUPEE',
      QAR:'QATARI RIYAL'
    };
    const NAMES = prefLang==='tr' ? NAMES_TR : NAMES_EN;

    let allRows = [];
    let loaded = false;
    let currentRecord = null;
    let compareWindow = null; // 1,7,30
    let charts = { main:null, spread:null };
    let chartsInitialized = false;
    let currentChartCode = null;
    let seriesByCode = {};
    let chartRangeMode = "all"; // all,7d,30d,1y,2y,5y,custom

    function setStatus(text, mode){
      const dot = status.querySelector(".status-dot");
      status.lastChild.textContent = " " + text;
      dot.classList.remove("status-loading","status-error");
      if(mode==="loading") dot.classList.add("status-loading");
      else if(mode==="error") dot.classList.add("status-error");
    }
    function smoothScrollToAnalytics() {
      const headerHeight = headerEl.offsetHeight + 20;
      const top = analyticsSection.getBoundingClientRect().top + window.scrollY - headerHeight;
      window.scrollTo({ top, behavior:"smooth" });
    }
    function parseDate(str){
      if(!str) return null;
      const d=new Date(str);
      return isNaN(d.getTime())?null:d;
    }

    function formatYMD(d){
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,"0");
      const day=String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function parseTarih(tStr){
      const parts = tStr.split("-").map(Number);
      if(parts[0]>1900){
        return new Date(parts[0],parts[1]-1,parts[2]);
      }
      return new Date(parts[2],parts[1]-1,parts[0]);
    }

    function sortRowsOnce(rows){
      rows.sort((a,b)=>parseTarih(a.TARIH)-parseTarih(b.TARIH));
    }

    function findRecordForTargetDate(targetTarih){
      if(!allRows.length) return null;
      if(!targetTarih) return allRows[allRows.length-1];

      const tDate = parseTarih(targetTarih);
      const firstD = parseTarih(allRows[0].TARIH);
      const lastD = parseTarih(allRows[allRows.length-1].TARIH);

      if(tDate.getTime()<=firstD.getTime()) return allRows[0];
      if(tDate.getTime()>=lastD.getTime()) return allRows[allRows.length-1];

      let candidate = allRows[0];
      for(let i=0;i<allRows.length;i++){
        const d = parseTarih(allRows[i].TARIH);
        if(d.getTime()===tDate.getTime()) return allRows[i];
        if(d.getTime()<=tDate.getTime()) candidate = allRows[i];
        else break;
      }
      return candidate;
    }

    function findRecordOffsetDays(baseTarih, daysBack){
      if(!allRows.length || !baseTarih) return null;
      const baseDate = parseTarih(baseTarih);
      const targetDate = new Date(baseDate.getTime() - daysBack*24*60*60*1000);

      let candidate = null;
      for(let i=0;i<allRows.length;i++){
        const d = parseTarih(allRows[i].TARIH);
        if(d.getTime()<=targetDate.getTime()) candidate = allRows[i];
        else break;
      }
      if(!candidate) candidate = allRows[0];
      return candidate;
    }

    async function ensureData(){
      if(loaded) return;
      try{
        setStatus(t.statusLoading, "loading");
        const res = await fetch(TCMB_URL);
        const rows = await res.json();
        sortRowsOnce(rows);
        allRows = rows;
        loaded = true;
        setStatus(t.statusReady, null);
      }catch(e){
        console.error(e);
        setStatus(t.statusError, "error");
        cards.innerHTML = `<div class='card'><div>${t.fetchError}</div></div>`;
      }
    }

    function getCompareLabel(days){
      if(prefLang==="tr"){
        if(days===1) return "1G";
        if(days===7) return "7G";
        if(days===30) return "1A";
      }else{
        if(days===1) return "1D";
        if(days===7) return "7D";
        if(days===30) return "1M";
      }
      return "";
    }

    function setCompareWindowFn(days){
      compareWindow = days;
      [btn1g,btn7g,btn30g].forEach(btn=>{
        btn.classList.toggle("active", Number(btn.dataset.days)===days);
      });
      if(currentRecord){
        render(currentRecord);
      }
    }

    function render(rec){
      if(!rec){
        cards.innerHTML=`<div class='card'><div>${t.noData}</div></div>`;
        return;
      }

      const amount = parseFloat(amountInput.value)||1000;
      const locale = prefLang==="tr" ? "tr-TR" : "en-US";
      const amountStr = amount.toLocaleString(locale);

      resultDate.innerHTML = `
        <span class="status-dot"></span>
        <span>${t.dateLabelPrefix}${rec.TARIH || "-"}</span>
      `;

      const labelCode = compareWindow ? getCompareLabel(compareWindow) : null;

      let html = "";
      CODES.forEach(code=>{
        const buy = parseFloat(rec[code+"_ALIS"]||"0");
        const sell = parseFloat(rec[code+"_SATIS"]||"0");
        if(!buy && !sell) return;

        const conv = sell ? (amount/sell).toFixed(2) : "";
        let changeHtml = "";
        if(compareWindow){
          const baseTarih = rec.TARIH;
          const cmpRec = findRecordOffsetDays(baseTarih, compareWindow);
          if(cmpRec){
            const prevSell = parseFloat(cmpRec[code+"_SATIS"]||"0");
            if(prevSell){
              const diff = sell - prevSell;
              const labelWord = t.changeWord;
              if(diff>0){
                changeHtml = `
                  <div class="change change-up">
                    <span class="change-label">${labelCode} ${labelWord}</span>
                    <span class="arrow">↑</span>
                    <span>${diff.toFixed(4)}</span>
                  </div>`;
              }else if(diff<0){
                changeHtml = `
                  <div class="change change-down">
                    <span class="change-label">${labelCode} ${labelWord}</span>
                    <span class="arrow">↓</span>
                    <span>${diff.toFixed(4)}</span>
                  </div>`;
              }else{
                changeHtml = `
                  <div class="change change-flat">
                    <span class="change-label">${labelCode} ${labelWord}</span>
                    <span>0.0000</span>
                  </div>`;
              }
            }
          }
        }

        html += `
          <div class="card" data-code="${code}">
            <div class="card-header">
              <div class="card-title">
                <div class="pair">${code}/TRY</div>
                <div class="name">${NAMES[code]||code}</div>
              </div>
              <div class="card-chip">
                <span class="card-chip-dot"></span>
                <span>${t.chipChart}</span>
              </div>
            </div>
            <div class="rates">
              <div>
                <span class="label">${t.labelBid}</span>
                <div>${buy.toFixed(4)}</div>
              </div>
              <div>
                <span class="label">${t.labelAsk}</span>
                <div>${sell.toFixed(4)}</div>
              </div>
            </div>
            <div class="conversion">
              <span>${t.convLabel(amountStr)}</span>
              <span class="conversion-amount">≈ ${conv} ${code}</span>
            </div>
            ${changeHtml}
          </div>
        `;
      });
      cards.innerHTML = html;

      if(currentChartCode){
        highlightActiveCard(currentChartCode);
      }
    }

    function highlightActiveCard(code){
      const cardEls = cards.querySelectorAll(".card");
      cardEls.forEach(c=>{
        c.classList.toggle("active-card", c.getAttribute("data-code")===code);
      });
    }

    async function loadForCurrentDate(){
      await ensureData();
      if(!allRows.length) return;

      const raw = dateInput.value; // yyyy-mm-dd
      const targetTarih = raw ? raw.split("-").reverse().join("-") : null; // dd-mm-yyyy
      const rec = findRecordForTargetDate(targetTarih);
      currentRecord = rec;
      render(rec);

      if(!chartsInitialized){
        chartsInitialized = true;
        const defaultCode = CODES[0] || "USD";
        updateDashboard(defaultCode);
      }
    }

    // ----- Analytics / Chart.js -----
    function buildSeriesForCode(code){
      if(!allRows.length) return [];
      const series = [];
      for(const r of allRows){
        const sell = parseFloat(r[code+"_SATIS"]||"0");
        const buy = parseFloat(r[code+"_ALIS"]||"0");
        if(!sell) continue;
        const d = parseTarih(r.TARIH);
        const dateStr = d.toISOString().split("T")[0];
        series.push({
          date: dateStr,
          buying: isNaN(buy) ? sell : buy,
          selling: sell
        });
      }
      series.sort((a,b)=>new Date(a.date)-new Date(b.date));
      return series;
    }

    function updateDashboard(code){
      if(!allRows.length) return;
      const data = buildSeriesForCode(code);
      seriesByCode[code] = data;

      if(!data.length){
        analyticsPairEl.textContent = code + "/TRY";
        analyticsSubtitleEl.textContent = (NAMES[code]||code);
        analyticsRangeEl.textContent = t.analyticsRangeLabel("--","--");
        if(analyticsStartEl) analyticsStartEl.textContent = "";
        kpiCurrent.textContent = "--";
        kpiChange.textContent = "--";
        kpiHigh.textContent = "--";
        kpiHighDate.textContent = t.kpiHighDatePrefix + " --";
        kpiSpread.textContent = "--";
        statsTableBody.innerHTML = "";
        if(charts.main) charts.main.destroy();
        if(charts.spread) charts.spread.destroy();
        currentChartCode = code;
        highlightActiveCard(code);
        return;
      }

      currentChartCode = code;
      highlightActiveCard(code);

      // Başlıklar
      analyticsPairEl.textContent = code + "/TRY";
      analyticsSubtitleEl.textContent = (NAMES[code]||code) + " · " + code;

      // Tarih input min/max
      const first = data[0];
      const last = data[data.length-1];
      chartFromInput.min = chartToInput.min = first.date;
      chartFromInput.max = chartToInput.max = last.date;
      if(!chartFromInput.value) chartFromInput.value = first.date;
      if(!chartToInput.value) chartToInput.value = last.date;

      // Veri başlangıç tarihi (full set)
      if(analyticsStartEl) analyticsStartEl.textContent = t.analyticsStartLabel(first.date);

      applyChartRange(); // tüm KPI+grafik+tabloyu seçili range'e göre güncelle
    }

    function applyChartRange(){
      const fullSeries = seriesByCode[currentChartCode] || [];
      if(!fullSeries.length){
        if(charts.main) charts.main.destroy();
        if(charts.spread) charts.spread.destroy();
        statsTableBody.innerHTML = "";
        analyticsRangeEl.textContent = t.analyticsRangeLabel("--","--");
        return;
      }

      let filtered = fullSeries.slice();
      const last = fullSeries[fullSeries.length-1];
      const lastDate = new Date(last.date);

      function filterLastDays(days){
        const ms = days*24*60*60*1000;
        const threshold = new Date(lastDate.getTime() - ms);
        filtered = fullSeries.filter(p=>new Date(p.date)>=threshold);
        if(!filtered.length) filtered = fullSeries.slice();
      }

      if(chartRangeMode==="7d") filterLastDays(7);
      else if(chartRangeMode==="30d") filterLastDays(30);
      else if(chartRangeMode==="1y") filterLastDays(365);
      else if(chartRangeMode==="2y") filterLastDays(365*2);
      else if(chartRangeMode==="5y") filterLastDays(365*5);
      else if(chartRangeMode==="custom"){
        const fromVal = chartFromInput.value;
        const toVal = chartToInput.value;
        if(fromVal && toVal){
          const fromD = new Date(fromVal);
          const toD = new Date(toVal);
          if(fromD <= toD){
            filtered = fullSeries.filter(p=>{
              const d = new Date(p.date);
              return d>=fromD && d<=toD;
            });
            if(!filtered.length) filtered = fullSeries.slice();
          }
        }
      }
      // chartRangeMode "all" => filtered zaten fullSeries

      const first = filtered[0];
      const lastF = filtered[filtered.length-1];
      analyticsRangeEl.textContent = t.analyticsRangeLabel(first.date,lastF.date);

      updateCharts(filtered);
      updateYearlyTable(filtered);
    }

    function updateCharts(data){
      const labels = data.map(d=>d.date);
      const sellingData = data.map(d=>d.selling);
      const buyingData = data.map(d=>d.buying);
      const spreadData = data.map(d=>d.selling-d.buying);

      const ctxMain = mainChartCanvas.getContext("2d");
      if(charts.main) charts.main.destroy();

      const gradientFill = ctxMain.createLinearGradient(0,0,0,220);
      gradientFill.addColorStop(0,"rgba(59,130,246,0.5)");
      gradientFill.addColorStop(1,"rgba(59,130,246,0.0)");

      charts.main = new Chart(ctxMain,{
        type:"line",
        data:{
          labels,
          datasets:[
            {
              label: prefLang==="tr" ? "Satış" : "Ask",
              data: sellingData,
              borderColor:"#3b82f6",
              backgroundColor: gradientFill,
              borderWidth:2,
              pointRadius:0,
              pointHoverRadius:5,
              fill:true,
              tension:0.35
            },
            {
              label: prefLang==="tr" ? "Alış" : "Bid",
              data: buyingData,
              borderColor:"#10b981",
              borderWidth:1,
              borderDash:[5,5],
              pointRadius:0,
              fill:false,
              tension:0.35
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          interaction:{mode:"index",intersect:false},
          plugins:{
            legend:{labels:{color:"#cbd5e1",font:{size:10}}},
            tooltip:{
              backgroundColor:"#020617",
              titleColor:"#e5e7eb",
              bodyColor:"#cbd5e1",
              borderColor:"#475569",
              borderWidth:1
            }
          },
          scales:{
            x:{
              grid:{color:"#1f2937"},
              ticks:{color:"#9ca3af",maxTicksLimit:8,font:{size:9}}
            },
            y:{
              grid:{color:"#1f2937"},
              ticks:{color:"#9ca3af",font:{size:9}}
            }
          }
        }
      });

      const ctxSpread = spreadChartCanvas.getContext("2d");
      if(charts.spread) charts.spread.destroy();

      charts.spread = new Chart(ctxSpread,{
        type:"bar",
        data:{
          labels,
          datasets:[{
            label:"Spread",
            data:spreadData,
            backgroundColor:"#f97316",
            borderRadius:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{legend:{display:false}},
          scales:{
            x:{display:false},
            y:{
              grid:{color:"#1f2937"},
              ticks:{color:"#9ca3af",font:{size:9}}
            }
          }
        }
      });

      // KPI'lar (range'e göre)
      if(data.length){
        const first = data[0];
        const last = data[data.length-1];
        const maxVal = Math.max(...data.map(d=>d.selling));
        const maxValData = data.find(d=>d.selling===maxVal);
        const totalChange = ((last.selling-first.selling)/first.selling)*100;
        const avgSpread = data.reduce((acc,c)=>acc+(c.selling-c.buying),0)/data.length;

        kpiCurrent.textContent = last.selling.toFixed(4);
        kpiChange.textContent = (totalChange>=0?"+":"") + totalChange.toFixed(2) + "%";
        kpiChange.classList.remove("kpi-up","kpi-down");
        kpiChange.classList.add(totalChange>=0 ? "kpi-up" : "kpi-down");
        kpiHigh.textContent = maxVal.toFixed(4);
        kpiHighDate.textContent = `${t.kpiHighDatePrefix} ${maxValData.date}`;
        kpiSpread.textContent = avgSpread.toFixed(4);
      }
    }

    function updateYearlyTable(data){
      const yearlyStats = {};
      data.forEach(row=>{
        const year = row.date.split("-")[0];
        if(!yearlyStats[year]){
          yearlyStats[year] = {sumBuy:0,sumSell:0,count:0};
        }
        yearlyStats[year].sumBuy += row.buying;
        yearlyStats[year].sumSell += row.selling;
        yearlyStats[year].count++;
      });

      statsTableBody.innerHTML = "";
      Object.keys(yearlyStats).sort().reverse().forEach(year=>{
        const stat = yearlyStats[year];
        const avgBuy = stat.sumBuy/stat.count;
        const avgSell = stat.sumSell/stat.count;

        const yearData = data.filter(d=>d.date.startsWith(year));
        const startVal = yearData[0].selling;
        const endVal = yearData[yearData.length-1].selling;
        const change = ((endVal-startVal)/startVal)*100;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${year}</td>
          <td style="color:#22c55e;">${avgBuy.toFixed(4)}</td>
          <td style="color:#38bdf8;">${avgSell.toFixed(4)}</td>
          <td style="font-weight:600;color:${change>=0?"#22c55e":"#f97373"};">
            ${(change>=0?"+":"")}${change.toFixed(2)}%
          </td>
        `;
        statsTableBody.appendChild(tr);
      });
    }

    // Scroll helpers
    function scrollToAnalytics(){
      analyticsSection.scrollIntoView({behavior:"smooth",block:"start"});
    }
    function scrollToTop(){
      headerEl.scrollIntoView({behavior:"smooth",block:"start"});
    }
    function smoothScrollTop() {
      window.scrollTo({ top: 0, behavior:"smooth" });
    }

    // Events
    btnFetch.addEventListener("click", ()=>{ loadForCurrentDate(); });
    btnLatest.addEventListener("click", ()=>{
      dateInput.value = "";
      loadForCurrentDate();
    });

    [btn1g,btn7g,btn30g].forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const days = Number(btn.dataset.days);
        if(compareWindow===days){
          compareWindow = null;
          [btn1g,btn7g,btn30g].forEach(b=>b.classList.remove("active"));
          if(currentRecord) render(currentRecord);
        }else{
          setCompareWindowFn(days);
        }
      });
    });

    // Kart tıklanınca analitik alanı güncelle + scroll
    cards.addEventListener("click",(e)=>{
      const card = e.target.closest(".card");
      if(!card) return;
      const code = card.getAttribute("data-code");
      if(!code) return;
      updateDashboard(code);
      smoothScrollToAnalytics();
    });

    // Detay Analiz butonu
    btnScrollAnalytics.addEventListener("click",()=>{
      smoothScrollToAnalytics();
    });

    // Yukarı dön butonu
    btnScrollTop.addEventListener("click",()=>{
      smoothScrollTop();
    });
    window.addEventListener("scroll",()=>{
      const y = window.scrollY || document.documentElement.scrollTop;
      if(y>200) btnScrollTop.classList.remove("hide");
      else btnScrollTop.classList.add("hide");
    });

    // Zaman aralığı butonları
    rangeButtons.forEach(btn=>{
      btn.addEventListener("click",()=>{
        const mode = btn.dataset.range;
        chartRangeMode = mode;
        rangeButtons.forEach(b=>b.classList.toggle("active",b===btn));
        if(mode!=="custom"){
          applyChartRange();
        }
      });
    });

    // Tarih aralığı uygula
    rangeApplyBtn.addEventListener("click",()=>{
      chartRangeMode = "custom";
      rangeButtons.forEach(b=>b.classList.remove("active"));
      applyChartRange();
      scrollToAnalytics();
    });

    const today = new Date();
    dateInput.value = formatYMD(today);
    dateInput.max = formatYMD(today);
    dateInput.addEventListener("change", ()=>{
      const picked = parseDate(dateInput.value);
      const now = new Date();
      if(picked && picked.getTime() > now.getTime()){
        dateInput.value = formatYMD(now);
      }
    });

    // İlk yükleme
    loadForCurrentDate();
  })();
  </script>
  <script src="../lang-helper.js"></script>
  <script src="../scroll-helper.js"></script>
  <script src="../page-lang.js"></script>
</body>
</html>
